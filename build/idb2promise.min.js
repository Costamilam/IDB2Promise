(function(a,b){"object"==typeof exports&&"undefined"!=typeof module?b(exports):"function"==typeof define&&define.amd?define(["exports"],b):(a=a||self,b(a.IDB2Promise={}))})(this,function(a){'use strict';/*! *****************************************************************************
    Copyright (c) Microsoft Corporation. All rights reserved.
    Licensed under the Apache License, Version 2.0 (the "License"); you may not use
    this file except in compliance with the License. You may obtain a copy of the
    License at http://www.apache.org/licenses/LICENSE-2.0

    THIS CODE IS PROVIDED ON AN *AS IS* BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
    KIND, EITHER EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION ANY IMPLIED
    WARRANTIES OR CONDITIONS OF TITLE, FITNESS FOR A PARTICULAR PURPOSE,
    MERCHANTABLITY OR NON-INFRINGEMENT.

    See the Apache Version 2.0 License for specific language governing permissions
    and limitations under the License.
    ***************************************************************************** */function b(a,b,c,d){return new(c||(c=Promise))(function(e,f){function g(a){try{i(d.next(a))}catch(a){f(a)}}function h(a){try{i(d["throw"](a))}catch(a){f(a)}}function i(a){a.done?e(a.value):new c(function(b){b(a.value)}).then(g,h)}i((d=d.apply(a,b||[])).next())})}var c=function(){this.dBName="AppDatabase",this.dBVersion=void 0,this.dBConnection=null,this.versionChangeTransaction=Promise.resolve(void 0),this.versionChangeTransactionResolve=function(){}};c.prototype.getObjecStore=function(a){return b(this,void 0,void 0,function*(){var b=this,c=yield this.getDatabase();return c.transaction instanceof IDBTransaction?(c.transaction.oncomplete=function(){return b.versionChangeTransactionResolve()},c.transaction.objectStore(this.objectStoreName)):c.transaction([this.objectStoreName],a).objectStore(this.objectStoreName)})},c.prototype.getReadableOnly=function(){return this.getObjecStore("readonly")},c.prototype.getReadableAndWritable=function(){return b(this,void 0,void 0,function*(){return this.getObjecStore("readwrite")})},c.prototype.getVersionChange=function(){return b(this,void 0,void 0,function*(){var a=this;return this.updateDB().then(function(){return a.getObjecStore()})})},c.prototype.getDatabase=function(){var a=this,c=this;return c.dBConnection?c.versionChangeTransaction.then(function(){return b(a,void 0,void 0,function*(){return c.dBVersion=c.dBConnection.version,c.dBConnection.objectStoreNames.contains(c.objectStoreName)?c.dBConnection:yield c.updateDB().then(c.getDatabase)})}):new Promise(function(d,e){var f=c.dBVersion&&!Number.isNaN(c.dBVersion)?indexedDB.open(c.dBName,c.dBVersion):indexedDB.open(c.dBName);f.onupgradeneeded=function(a){c.versionChangeTransaction=new Promise(function(a){return c.versionChangeTransactionResolve=a}),c.dBConnection=f.result,c.dBVersion=c.dBConnection.version,c.dBConnection.objectStoreNames.contains(c.objectStoreName)||c.dBConnection.createObjectStore(c.objectStoreName,c.objectStoreOptions),d(a.currentTarget)},f.onsuccess=function(e){c.versionChangeTransaction.then(function(){c.dBConnection=e.target.result,c.dBVersion=c.dBConnection.version,c.dBConnection.objectStoreNames.contains(c.objectStoreName)||c.updateDB().then(function(){return b(a,void 0,void 0,function*(){return d((yield c.getDatabase()))})}),d(c.dBConnection)})},f.onerror=function(a){c.dBConnection instanceof IDBDatabase&&(c.dBConnection.close(),c.dBConnection=null),e(a)}})},c.prototype.updateDB=function(){var a=this;return this.dBConnection instanceof IDBDatabase?(this.dBVersion=this.dBConnection.version+1,this.dBConnection.close(),this.dBConnection=null,Promise.resolve(void 0)):this.dBVersion?(this.dBVersion++,Promise.resolve(void 0)):this.getDatabase().then(function(){return a.dBVersion=a.dBConnection.version+1,a.dBConnection.close(),void(a.dBConnection=null)})};var d=/*@__PURE__*/function(a){function b(b){a.call(this,function(a,c){b instanceof Function?b(a,c):b.then(function(b){b instanceof IDBRequest?(b.onsuccess=function(b){return a(b.target.result)},b.onerror=function(a){return c(a)}):a(b)})})}return a&&(b.__proto__=a),b.prototype=Object.create(a&&a.prototype),b.prototype.constructor=b,b}(Promise),e=function(a){var b=this;if(this.request=a,this.errorHandlers=[],this.successHandlers=[],this.finallyHandlers=[],this.successRequestEvent=null,this.errorRequestEvent=null,a instanceof Function);else a.then(function(a){a.addEventListener("success",b.createListener(b.successHandlers)),a.addEventListener("error",b.createListener(b.errorHandlers))})};e.prototype.createListener=function(a){var b=this;return function(c){var d="success"===c.type?"successRequestEvent":"errorRequestEvent";null===b[d]&&(b[d]=c);var e=c.target.result;if(e){for(var f of a)e=f.call(e,e);c.target.result.continue()}else for(var g of b.finallyHandlers)g.call(void 0)}},e.prototype.each=function(a){return this.successHandlers.push(a),null!==this.successRequestEvent&&this.createListener(this.successHandlers)(this.successRequestEvent),this},e.prototype.catch=function(a){return this.errorHandlers.push(a),null!==this.errorRequestEvent&&this.createListener(this.successHandlers)(this.errorRequestEvent),this},e.prototype.finally=function(a){return this.finallyHandlers.push(a),(null!==this.successRequestEvent||null!==this.errorRequestEvent)&&this.createListener([])(void 0),this};var f=/*@__PURE__*/function(a){function b(){a.call(this)}return a&&(b.__proto__=a),b.prototype=Object.create(a&&a.prototype),b.prototype.constructor=b,b.prototype.count=function(){return new d(this.getReadableOnly().then(function(a){return a.count()}))},b.prototype.get=function(a){return new d(this.getReadableOnly().then(function(b){return b.get(a)}))},b.prototype.getAll=function(a,b){return new d(this.getReadableOnly().then(function(c){return c.getAll(a,b)}))},b.prototype.getAllKeys=function(a,b){return new d(this.getReadableOnly().then(function(c){return c.getAllKeys(a,b)}))},b.prototype.getKey=function(a){return new d(this.getReadableOnly().then(function(b){return b.getKey(a)}))},b.prototype.iterate=function(a,b,c){return void 0===c&&(c=!1),new e(this[c?"getReadableOnly":"getReadableAndWritable"]().then(function(c){return c.openCursor(a,b)}))},b.prototype.iterateKeys=function(a,b){return new e(this.getReadableOnly().then(function(c){return c.openKeyCursor(a,b)}))},b.prototype.add=function(a,b){return new d(this.getReadableAndWritable().then(function(c){return c.add(a,b)}))},b.prototype.put=function(a,b){return new d(this.getReadableAndWritable().then(function(c){return c.put(JSON.parse(JSON.stringify(a)),b)}))},b.prototype.delete=function(a){return new d(this.getReadableAndWritable().then(function(b){return b.delete(a)}))},b.prototype.clear=function(){return new d(this.getReadableAndWritable().then(function(a){return a.clear()}))},b.prototype.index=function(a){return new d(this.getReadableOnly().then(function(b){return b.index(a)}))},b.prototype.getIndexNames=function(){return new d(this.getReadableOnly().then(function(a){return a.indexNames})).then(function(a){return Array.from(a)})},b.prototype.createIndex=function(a,b,c){return new d(this.getVersionChange().then(function(d){return d.createIndex(a,b,c)}))},b.prototype.deleteIndex=function(a){return new d(this.getVersionChange().then(function(b){return b.deleteIndex(a)}))},b}(c);a.ObjectStore=f,Object.defineProperty(a,"__esModule",{value:!0})});
